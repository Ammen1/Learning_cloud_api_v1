// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-py"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User Management - Optimized for 20M+ students
model User {
  id                String   @id @default(cuid())
  email             String?  @unique
  username          String   @unique
  first_name        String
  last_name         String
  role              UserRole @default(STUDENT)
  is_active         Boolean  @default(true)
  is_verified       Boolean  @default(false)
  last_login        DateTime?
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt

  // Student specific fields
  student_id        String?  @unique
  pin               String?  // Encrypted PIN
  grade_level       Int?     // 1-4
  parent_email      String?
  school_id         String?
  school            School?  @relation("SchoolStudents", fields: [school_id], references: [id])
  
  // Teacher specific fields
  teacher_id        String?  @unique
  subject_specialties String[] // Array of subjects
  teacher_school_id String?
  teacher_school    School?  @relation("SchoolTeachers", fields: [teacher_school_id], references: [id])
  
  // Relationships
  student_progress  StudentProgress[]
  quiz_attempts     QuizAttempt[]
  notifications     Notification[]
  parent_children   User[]   @relation("ParentChild")
  parent            User?    @relation("ParentChild", fields: [parent_id], references: [id])
  parent_id         String?
  
  // Indexes for performance
  @@index([student_id])
  @@index([teacher_id])
  @@index([grade_level])
  @@index([role])
  @@index([is_active])
  @@map("users")
}

enum UserRole {
  STUDENT
  TEACHER
  PARENT
  ADMIN
}

// School Management
model School {
  id          String   @id @default(cuid())
  name        String
  address     String?
  city        String?
  country     String   @default("Ethiopia")
  is_active   Boolean  @default(true)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  // Relationships
  students    User[] @relation("SchoolStudents")
  teachers    User[] @relation("SchoolTeachers")
  subjects    Subject[]

  @@map("schools")
}

// Content Management - Hierarchical structure
model Subject {
  id          String   @id @default(cuid())
  name        String
  description String?
  grade_level Int      // 1-4
  school_id   String?
  is_active   Boolean  @default(true)
  order_index Int      @default(0)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  // Relationships
  school      School?  @relation(fields: [school_id], references: [id])
  chapters    Chapter[]
  quizzes     Quiz[]

  @@index([grade_level])
  @@index([school_id])
  @@index([is_active])
  @@map("subjects")
}

model Chapter {
  id          String   @id @default(cuid())
  title       String
  description String?
  subject_id  String
  order_index Int      @default(0)
  is_active   Boolean  @default(true)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  // Relationships
  subject     Subject  @relation(fields: [subject_id], references: [id])
  lessons     Lesson[]

  @@index([subject_id])
  @@index([order_index])
  @@map("chapters")
}

model Lesson {
  id          String      @id @default(cuid())
  title       String
  content     String      // Rich text content
  content_type LessonType @default(SLIDES)
  video_url   String?
  audio_url   String?
  duration    Int?        // Duration in minutes
  chapter_id  String
  order_index Int         @default(0)
  is_active   Boolean     @default(true)
  is_premium  Boolean     @default(false)
  created_at  DateTime    @default(now())
  updated_at  DateTime    @updatedAt

  // Relationships
  chapter     Chapter     @relation(fields: [chapter_id], references: [id])
  progress    StudentProgress[]
  quiz        Quiz?

  @@index([chapter_id])
  @@index([order_index])
  @@index([is_active])
  @@map("lessons")
}

enum LessonType {
  SLIDES
  VIDEO
  AUDIO
  READING
  INTERACTIVE
}

// Quiz System
model Quiz {
  id          String     @id @default(cuid())
  title       String
  description String?
  lesson_id   String?    @unique // Optional - can be standalone
  subject_id  String
  grade_level Int
  time_limit  Int?       // Time limit in minutes
  max_attempts Int       @default(3)
  passing_score Int      @default(70)
  is_active   Boolean    @default(true)
  created_at  DateTime   @default(now())
  updated_at  DateTime   @updatedAt

  // Relationships
  lesson      Lesson?    @relation(fields: [lesson_id], references: [id])
  subject     Subject    @relation(fields: [subject_id], references: [id])
  questions   Question[]
  attempts    QuizAttempt[]

  @@index([subject_id])
  @@index([grade_level])
  @@index([is_active])
  @@map("quizzes")
}

model Question {
  id          String       @id @default(cuid())
  quiz_id     String
  question_text String
  question_type QuestionType
  options     Json?        // For multiple choice questions
  correct_answer Json      // Flexible answer format
  explanation String?
  points      Int          @default(1)
  order_index Int          @default(0)
  is_active   Boolean      @default(true)
  created_at  DateTime     @default(now())
  updated_at  DateTime     @updatedAt

  // Relationships
  quiz        Quiz         @relation(fields: [quiz_id], references: [id])
  answers     Answer[]

  @@index([quiz_id])
  @@index([order_index])
  @@map("questions")
}

enum QuestionType {
  MULTIPLE_CHOICE
  TRUE_FALSE
  MATCHING
  FILL_IN_BLANK
  SHORT_ANSWER
}

// Progress Tracking - Optimized for large scale
model StudentProgress {
  id          String   @id @default(cuid())
  student_id  String
  lesson_id   String
  status      ProgressStatus @default(NOT_STARTED)
  started_at  DateTime?
  completed_at DateTime?
  time_spent  Int      @default(0) // Time spent in seconds
  score       Float?
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  // Relationships
  student     User     @relation(fields: [student_id], references: [id])
  lesson      Lesson   @relation(fields: [lesson_id], references: [id])

  @@unique([student_id, lesson_id])
  @@index([student_id])
  @@index([lesson_id])
  @@index([status])
  @@index([completed_at])
  @@map("student_progress")
}

enum ProgressStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  PAUSED
}

// Quiz Attempts
model QuizAttempt {
  id          String   @id @default(cuid())
  student_id  String
  quiz_id     String
  started_at  DateTime @default(now())
  completed_at DateTime?
  score       Float?
  total_questions Int
  correct_answers Int
  time_spent  Int      // Time spent in seconds
  is_passed   Boolean  @default(false)
  created_at  DateTime @default(now())

  // Relationships
  student     User     @relation(fields: [student_id], references: [id])
  quiz        Quiz     @relation(fields: [quiz_id], references: [id])
  answers     Answer[]

  @@index([student_id])
  @@index([quiz_id])
  @@index([completed_at])
  @@index([is_passed])
  @@map("quiz_attempts")
}

model Answer {
  id          String   @id @default(cuid())
  attempt_id  String
  question_id String
  answer_text String?
  is_correct  Boolean
  points_earned Float  @default(0)
  time_spent  Int      @default(0)
  created_at  DateTime @default(now())

  // Relationships
  attempt     QuizAttempt @relation(fields: [attempt_id], references: [id])
  question    Question    @relation(fields: [question_id], references: [id])

  @@unique([attempt_id, question_id])
  @@index([attempt_id])
  @@index([question_id])
  @@map("answers")
}

// Analytics and Reporting
model Analytics {
  id          String   @id @default(cuid())
  student_id  String?
  teacher_id  String?
  school_id   String?
  metric_type String   // 'lesson_completion', 'quiz_score', 'time_spent', etc.
  metric_value Float
  metadata    Json?    // Additional context data
  date        DateTime @default(now())
  created_at  DateTime @default(now())

  @@index([student_id])
  @@index([teacher_id])
  @@index([school_id])
  @@index([metric_type])
  @@index([date])
  @@map("analytics")
}

// Notifications System
model Notification {
  id          String   @id @default(cuid())
  user_id     String
  title       String
  message     String
  type        NotificationType
  is_read     Boolean  @default(false)
  data        Json?    // Additional data for the notification
  created_at  DateTime @default(now())
  read_at     DateTime?

  // Relationships
  user        User     @relation(fields: [user_id], references: [id])

  @@index([user_id])
  @@index([is_read])
  @@index([created_at])
  @@map("notifications")
}

enum NotificationType {
  LESSON_COMPLETED
  QUIZ_RESULT
  ACHIEVEMENT
  REMINDER
  SYSTEM
}

// Gamification System
model Achievement {
  id          String   @id @default(cuid())
  name        String
  description String
  icon_url    String?
  points      Int      @default(0)
  category    String   // 'completion', 'streak', 'score', etc.
  criteria    Json     // Criteria for earning the achievement
  is_active   Boolean  @default(true)
  created_at  DateTime @default(now())

  @@map("achievements")
}

model UserAchievement {
  id            String   @id @default(cuid())
  user_id       String
  achievement_id String
  earned_at     DateTime @default(now())

  @@unique([user_id, achievement_id])
  @@index([user_id])
  @@map("user_achievements")
}

// System Configuration
model SystemConfig {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String
  description String?
  updated_at  DateTime @updatedAt

  @@map("system_config")
}
